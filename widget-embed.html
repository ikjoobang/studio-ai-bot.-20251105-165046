<!-- 
  Studio AI Bot - ì›¹ì‚¬ì´íŠ¸ ì„ë² ë“œ ìœ„ì ¯
  ì‚¬ìš©ë²•: ì´ ì½”ë“œë¥¼ ë‹¹ì‹ ì˜ ì›¹ì‚¬ì´íŠ¸ </body> íƒœê·¸ ì§ì „ì— ë¶™ì—¬ë„£ê¸°
-->

<!-- Studio AI Bot ìœ„ì ¯ -->
<div id="studio-ai-widget"></div>

<style>
/* ì±—ë´‡ ë²„íŠ¼ (ìš°ì¸¡ í•˜ë‹¨) */
#chat-button {
  position: fixed;
  bottom: 24px;
  right: 24px;
  width: 60px;
  height: 60px;
  border-radius: 50%;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 9999;
  transition: transform 0.3s ease;
}

#chat-button:hover {
  transform: scale(1.1);
}

#chat-button svg {
  width: 28px;
  height: 28px;
  fill: white;
}

/* ì±—ë´‡ ì°½ */
#chat-window {
  display: none;
  position: fixed;
  bottom: 100px;
  right: 24px;
  width: 380px;
  height: 600px;
  max-height: calc(100vh - 140px);
  background: white;
  border-radius: 16px;
  box-shadow: 0 8px 32px rgba(0,0,0,0.12);
  z-index: 9998;
  flex-direction: column;
  overflow: hidden;
}

#chat-window.active {
  display: flex;
}

/* í—¤ë” */
#chat-header {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  padding: 20px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

#chat-header h3 {
  margin: 0;
  font-size: 18px;
  font-weight: 600;
}

#close-chat {
  background: none;
  border: none;
  color: white;
  font-size: 24px;
  cursor: pointer;
  padding: 0;
  width: 30px;
  height: 30px;
}

/* ë©”ì‹œì§€ ì˜ì—­ */
#chat-messages {
  flex: 1;
  overflow-y: auto;
  padding: 20px;
  background: #f8f9fa;
}

.message {
  margin-bottom: 16px;
  display: flex;
  gap: 12px;
}

.message.bot {
  justify-content: flex-start;
}

.message.user {
  justify-content: flex-end;
}

.message-content {
  max-width: 75%;
  padding: 12px 16px;
  border-radius: 12px;
  word-wrap: break-word;
  line-height: 1.5;
}

.message.bot .message-content {
  background: white;
  border: 1px solid #e9ecef;
}

.message.user .message-content {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
}

/* ì…ë ¥ ì˜ì—­ */
#chat-input-area {
  padding: 16px;
  background: white;
  border-top: 1px solid #e9ecef;
  display: flex;
  gap: 8px;
}

#chat-input {
  flex: 1;
  padding: 12px 16px;
  border: 1px solid #e9ecef;
  border-radius: 24px;
  outline: none;
  font-size: 14px;
}

#chat-input:focus {
  border-color: #667eea;
}

#send-button {
  padding: 12px 24px;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  border: none;
  border-radius: 24px;
  cursor: pointer;
  font-weight: 600;
  transition: opacity 0.2s;
}

#send-button:hover {
  opacity: 0.9;
}

#send-button:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

/* ì´ˆê¸° ë©”ë‰´ */
.initial-menu {
  display: flex;
  flex-direction: column;
  gap: 12px;
  margin-top: 12px;
}

.menu-button {
  padding: 16px;
  background: white;
  border: 2px solid #667eea;
  border-radius: 12px;
  cursor: pointer;
  text-align: left;
  transition: all 0.3s ease;
}

.menu-button:hover {
  background: #667eea;
  color: white;
  transform: translateY(-2px);
}

.menu-button .emoji {
  font-size: 24px;
  margin-right: 12px;
}

.menu-button .title {
  font-weight: 600;
  font-size: 16px;
}

.menu-button .desc {
  font-size: 13px;
  color: #6c757d;
  margin-top: 4px;
}

.menu-button:hover .desc {
  color: rgba(255, 255, 255, 0.8);
}

/* ì‚¬ìš© íšŸìˆ˜ í‘œì‹œ */
#usage-counter {
  background: #fff3cd;
  padding: 12px;
  text-align: center;
  font-size: 13px;
  border-top: 1px solid #ffc107;
}

#usage-counter.warning {
  background: #f8d7da;
  border-top-color: #dc3545;
}

#usage-counter a {
  color: #dc3545;
  font-weight: 600;
  text-decoration: none;
}

/* ë¡œë”© ì• ë‹ˆë©”ì´ì…˜ */
.typing-indicator {
  display: inline-flex;
  gap: 4px;
  padding: 12px 16px;
}

.typing-indicator span {
  width: 8px;
  height: 8px;
  background: #667eea;
  border-radius: 50%;
  animation: typing 1.4s infinite;
}

.typing-indicator span:nth-child(2) {
  animation-delay: 0.2s;
}

.typing-indicator span:nth-child(3) {
  animation-delay: 0.4s;
}

@keyframes typing {
  0%, 60%, 100% {
    transform: translateY(0);
  }
  30% {
    transform: translateY(-10px);
  }
}

/* ëª¨ë°”ì¼ ëŒ€ì‘ */
@media (max-width: 768px) {
  #chat-window {
    width: calc(100vw - 32px);
    height: calc(100vh - 140px);
    right: 16px;
    bottom: 90px;
  }
  
  #chat-button {
    right: 16px;
    bottom: 16px;
  }
}
</style>

<script>
// ì„¤ì •
const CONFIG = {
  API_URL: 'http://localhost:3000/api', // ë°°í¬ í›„ ì‹¤ì œ ë„ë©”ì¸ìœ¼ë¡œ ë³€ê²½
  FREE_LIMIT: 10,
};

// ìƒíƒœ ê´€ë¦¬
let chatState = {
  isOpen: false,
  messages: [],
  usageCount: 0,
  selectedMode: null,
  isProcessing: false,
};

// ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì—ì„œ ì‚¬ìš© íšŸìˆ˜ ë¶ˆëŸ¬ì˜¤ê¸°
function loadUsageCount() {
  const saved = localStorage.getItem('studio_ai_usage');
  if (saved) {
    const data = JSON.parse(saved);
    chatState.usageCount = data.count || 0;
  }
}

// ì‚¬ìš© íšŸìˆ˜ ì €ì¥
function saveUsageCount() {
  localStorage.setItem('studio_ai_usage', JSON.stringify({
    count: chatState.usageCount,
    lastUsed: new Date().toISOString()
  }));
}

// ìœ„ì ¯ HTML ìƒì„±
function createWidget() {
  const widget = document.getElementById('studio-ai-widget');
  
  widget.innerHTML = `
    <!-- ì±—ë´‡ ë²„íŠ¼ -->
    <div id="chat-button">
      <svg viewBox="0 0 24 24">
        <path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2z"/>
      </svg>
    </div>

    <!-- ì±—ë´‡ ì°½ -->
    <div id="chat-window">
      <!-- í—¤ë” -->
      <div id="chat-header">
        <h3>ğŸ¤– Studio AI Bot</h3>
        <button id="close-chat">Ã—</button>
      </div>

      <!-- ë©”ì‹œì§€ ì˜ì—­ -->
      <div id="chat-messages"></div>

      <!-- ì‚¬ìš© íšŸìˆ˜ -->
      <div id="usage-counter">
        ë¬´ë£Œ ì²´í—˜: ${CONFIG.FREE_LIMIT - chatState.usageCount}íšŒ ë‚¨ìŒ
      </div>

      <!-- ì…ë ¥ ì˜ì—­ -->
      <div id="chat-input-area">
        <input type="text" id="chat-input" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." />
        <button id="send-button">ì „ì†¡</button>
      </div>
    </div>
  `;

  // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
  document.getElementById('chat-button').addEventListener('click', toggleChat);
  document.getElementById('close-chat').addEventListener('click', toggleChat);
  document.getElementById('send-button').addEventListener('click', sendMessage);
  document.getElementById('chat-input').addEventListener('keypress', (e) => {
    if (e.key === 'Enter' && !chatState.isProcessing) sendMessage();
  });
}

// ì±—ë´‡ ì—´ê¸°/ë‹«ê¸°
function toggleChat() {
  chatState.isOpen = !chatState.isOpen;
  const chatWindow = document.getElementById('chat-window');
  
  if (chatState.isOpen) {
    chatWindow.classList.add('active');
    if (chatState.messages.length === 0) {
      showInitialMenu();
    }
  } else {
    chatWindow.classList.remove('active');
  }
}

// ì´ˆê¸° ë©”ë‰´ í‘œì‹œ
function showInitialMenu() {
  const messagesDiv = document.getElementById('chat-messages');
  messagesDiv.innerHTML = `
    <div class="message bot">
      <div class="message-content">
        <strong>ì•ˆë…•í•˜ì„¸ìš”! ğŸ‘‹</strong><br><br>
        ë¬´ì—‡ì„ ë„ì™€ë“œë¦´ê¹Œìš”?
        
        <div class="initial-menu">
          <div class="menu-button" onclick="selectMode('inquiry')">
            <div class="emoji">ğŸ’¼</div>
            <div class="title">ì¼ë°˜ ìƒë‹´</div>
            <div class="desc">ì„œë¹„ìŠ¤ ë¬¸ì˜, ê²¬ì  ìš”ì²­, í¬íŠ¸í´ë¦¬ì˜¤ ì•ˆë‚´</div>
          </div>
          
          <div class="menu-button" onclick="selectMode('consulting')">
            <div class="emoji">ğŸ¯</div>
            <div class="title">ì „ë¬¸ ì»¨ì„¤íŒ…</div>
            <div class="desc">AI ë§ˆì¼€íŒ…, ì˜ìƒ ì „ëµ, ë¹„ì¦ˆë‹ˆìŠ¤ ì„±ì¥ ì¡°ì–¸</div>
          </div>
        </div>
      </div>
    </div>
  `;
}

// ëª¨ë“œ ì„ íƒ
window.selectMode = function(mode) {
  chatState.selectedMode = mode;
  
  const modeText = mode === 'inquiry' 
    ? 'ì¼ë°˜ ìƒë‹´' 
    : 'ì „ë¬¸ ì»¨ì„¤íŒ…';
  
  addMessage(`${modeText}ì„ ì„ íƒí•˜ì…¨ìŠµë‹ˆë‹¤.`, 'user');
  
  if (mode === 'inquiry') {
    addMessage(`
      ê°ì‚¬í•©ë‹ˆë‹¤! ğŸ˜Š<br><br>
      
      <strong>ì œê³µ ì„œë¹„ìŠ¤:</strong><br>
      â€¢ AI ì˜ìƒ ì œì‘ (B2B, LinkedIn, YouTube)<br>
      â€¢ AI ë§ˆì¼€íŒ… ìë™í™” (30ê°œ ë´‡ í”Œë«í¼)<br>
      â€¢ ë¸”ë¡œê·¸ â†’ ì˜ìƒ â†’ ì»¨ì„¤íŒ… íŒŒì´í”„ë¼ì¸<br><br>
      
      ì–´ë–¤ ì„œë¹„ìŠ¤ê°€ ê¶ê¸ˆí•˜ì‹ ê°€ìš”?<br>
      í¸í•˜ê²Œ ì§ˆë¬¸í•´ì£¼ì„¸ìš”!
    `, 'bot');
  } else {
    addMessage(`
      ì „ë¬¸ ì»¨ì„¤íŒ… ëª¨ë“œì…ë‹ˆë‹¤! ğŸ¯<br><br>
      
      <strong>ì „ë¬¸ ë¶„ì•¼:</strong><br>
      â€¢ AI ë§ˆì¼€íŒ… ì „ëµ<br>
      â€¢ ì˜ìƒ ì½˜í…ì¸  ì „ëµ<br>
      â€¢ ë¹„ì¦ˆë‹ˆìŠ¤ ì„±ì¥ ì»¨ì„¤íŒ…<br>
      â€¢ ìë™í™” ì‹œìŠ¤í…œ êµ¬ì¶•<br><br>
      
      ì–´ë–¤ ê³ ë¯¼ì´ ìˆìœ¼ì‹ ê°€ìš”?<br>
      ê¹Šì´ ìˆëŠ” ì¡°ì–¸ì„ ë“œë¦¬ê² ìŠµë‹ˆë‹¤.
    `, 'bot');
  }
}

// ë©”ì‹œì§€ ì¶”ê°€
function addMessage(text, sender) {
  const messagesDiv = document.getElementById('chat-messages');
  const messageDiv = document.createElement('div');
  messageDiv.className = `message ${sender}`;
  messageDiv.innerHTML = `
    <div class="message-content">${text}</div>
  `;
  messagesDiv.appendChild(messageDiv);
  messagesDiv.scrollTop = messagesDiv.scrollHeight;
  
  chatState.messages.push({ text, sender });
}

// ë¡œë”© í‘œì‹œ
function showLoading() {
  const messagesDiv = document.getElementById('chat-messages');
  const loadingDiv = document.createElement('div');
  loadingDiv.className = 'message bot';
  loadingDiv.id = 'loading-message';
  loadingDiv.innerHTML = `
    <div class="message-content">
      <div class="typing-indicator">
        <span></span>
        <span></span>
        <span></span>
      </div>
    </div>
  `;
  messagesDiv.appendChild(loadingDiv);
  messagesDiv.scrollTop = messagesDiv.scrollHeight;
}

// ë¡œë”© ì œê±°
function hideLoading() {
  const loading = document.getElementById('loading-message');
  if (loading) loading.remove();
}

// ë©”ì‹œì§€ ì „ì†¡
async function sendMessage() {
  const input = document.getElementById('chat-input');
  const sendButton = document.getElementById('send-button');
  const message = input.value.trim();
  
  if (!message || chatState.isProcessing) return;
  
  // ëª¨ë“œ ì„ íƒ í™•ì¸
  if (!chatState.selectedMode) {
    addMessage('ë¨¼ì € ìƒë‹´ ì¢…ë¥˜ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”! ğŸ˜Š', 'bot');
    return;
  }
  
  // ë¬´ë£Œ íšŸìˆ˜ í™•ì¸
  if (chatState.usageCount >= CONFIG.FREE_LIMIT) {
    showUpgradeMessage();
    return;
  }
  
  // ì²˜ë¦¬ ì‹œì‘
  chatState.isProcessing = true;
  sendButton.disabled = true;
  
  // ì‚¬ìš©ì ë©”ì‹œì§€ í‘œì‹œ
  addMessage(message, 'user');
  input.value = '';
  
  // ë¡œë”© í‘œì‹œ
  showLoading();
  
  try {
    // API í˜¸ì¶œ
    const response = await fetch(`${CONFIG.API_URL}/chat`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        message: message,
        mode: chatState.selectedMode,
        history: chatState.messages.slice(-10),
      }),
    });
    
    if (!response.ok) {
      throw new Error('API ì‘ë‹µ ì˜¤ë¥˜');
    }
    
    const data = await response.json();
    
    // ë¡œë”© ì œê±°
    hideLoading();
    
    // AI ë‹µë³€ í‘œì‹œ
    addMessage(data.reply, 'bot');
    
    // ì¼ë°˜ ìƒë‹´ ëª¨ë“œì¼ ë•Œ ì „í™˜ ìœ ë„
    if (chatState.selectedMode === 'inquiry' && chatState.messages.length > 6) {
      setTimeout(() => {
        addMessage(`
          ğŸ’¡ <strong>ë” ìì„¸í•œ ìƒë‹´ì„ ì›í•˜ì‹œë‚˜ìš”?</strong><br><br>
          ì´ë©”ì¼ë¡œ ë§ì¶¤ ì œì•ˆì„œë¥¼ ë³´ë‚´ë“œë¦½ë‹ˆë‹¤!<br>
          ğŸ“§ studio.ikjoo@gmail.com<br><br>
          ë˜ëŠ” ê³„ì† ëŒ€í™”í•˜ì…”ë„ ì¢‹ìŠµë‹ˆë‹¤ ğŸ˜Š
        `, 'bot');
      }, 2000);
    }
    
    // ì‚¬ìš© íšŸìˆ˜ ì¦ê°€
    chatState.usageCount++;
    saveUsageCount();
    updateUsageCounter();
    
  } catch (error) {
    console.error('Error:', error);
    hideLoading();
    addMessage('ì£„ì†¡í•©ë‹ˆë‹¤. ì¼ì‹œì ì¸ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.<br>ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.', 'bot');
  } finally {
    chatState.isProcessing = false;
    sendButton.disabled = false;
  }
}

// ì‚¬ìš© íšŸìˆ˜ ì—…ë°ì´íŠ¸
function updateUsageCounter() {
  const counter = document.getElementById('usage-counter');
  const remaining = CONFIG.FREE_LIMIT - chatState.usageCount;
  
  if (remaining > 0) {
    counter.innerHTML = `ë¬´ë£Œ ì²´í—˜: ${remaining}íšŒ ë‚¨ìŒ`;
    counter.className = '';
  } else {
    counter.innerHTML = `ë¬´ë£Œ ì²´í—˜ ì¢…ë£Œ - <a href="#upgrade" onclick="showUpgradeMessage()">ìœ ë£Œ ì „í™˜í•˜ê¸°</a>`;
    counter.className = 'warning';
  }
}

// ìœ ë£Œ ì „í™˜ ë©”ì‹œì§€
function showUpgradeMessage() {
  addMessage(`
    ğŸ‰ <strong>ë¬´ë£Œ ì²´í—˜ì„ ëª¨ë‘ ì‚¬ìš©í•˜ì…¨ìŠµë‹ˆë‹¤!</strong><br><br>
    
    ê³„ì† ì‚¬ìš©í•˜ì‹œë ¤ë©´ í”„ë¦¬ë¯¸ì—„ìœ¼ë¡œ ì „í™˜í•´ì£¼ì„¸ìš”:<br><br>
    
    <strong>ğŸ’ í”„ë¦¬ë¯¸ì—„ í”Œëœ</strong><br>
    â€¢ ì›” â‚©14,900 (ì˜¤í”ˆ íŠ¹ê°€!)<br>
    â€¢ ì›” 100íšŒ ìƒë‹´<br>
    â€¢ ì¼ë°˜ ìƒë‹´ + ì „ë¬¸ ì»¨ì„¤íŒ…<br>
    â€¢ ìš°ì„  ì‘ë‹µ (24ì‹œê°„ ë‚´)<br>
    â€¢ ì´ë©”ì¼ ë§ì¶¤ ì»¨ì„¤íŒ…<br><br>
    
    ğŸ“§ ê°€ì… ë¬¸ì˜: studio.ikjoo@gmail.com<br>
    <small>ì§€ê¸ˆ ê°€ì…í•˜ì‹œë©´ <strong>ì˜êµ¬ í• ì¸ ê°€ê²©</strong> ì ìš©ë©ë‹ˆë‹¤!</small>
  `, 'bot');
}

// ì´ˆê¸°í™”
document.addEventListener('DOMContentLoaded', function() {
  loadUsageCount();
  createWidget();
  updateUsageCounter();
});
</script>
